---
title: "Estimating the shooting efficiency of top NBA point guard"
author: "Xiang Gao, Jerome Finn, Nilesh Malpekar"
date: "2017/12/03"
output: html_document
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
```{r,  echo = FALSE, eval = FALSE}
install.packages("dplyr")
install.packages("gridExtra")
```

```{r}
library(rjags)
library(coda)
library(lattice)
library(gridExtra)
library(ggplot2)
library("dplyr")
```

# Purpose

## Background 

As we all know,a point guard controll the court by passing the ball to the player who is wide open. He is a decision maker to deliver assists or finish the attack by himself. The question arises, who has the highest shooting percentage among the top NBA point guards. Is this related to the professional years of experience.

We are using logistic regression to assess the probablity of shooting, also use a binomial model to estimate FGM. In order to build a hierachical model, each player is treated as a individual group by introducing a random effect called player effect. What's more, recent three years data will be used to check the continuous improvement.

# Data

```{r}
# load data
season_data <- read.table("Seasons_Stats.csv", header=TRUE, sep = ",", quote = '"')
player_data <- read.table("Players.csv", header=TRUE, sep = ",", quote = '"')
```

```{r}
# season data has multiple records for a player and year
season_data <- season_data[with(season_data, order(Year, Player, -FG)), ]
```

```{r}
season_data <- distinct(season_data, Year, Player, .keep_all = TRUE)
```

```{r}
season_data <- season_data %>% group_by(Player) %>% mutate(Experience = 1:n())
```

```{r}
# From players data only interested in height
player_data <- subset(player_data, select = c("Player", "height"))
colnames(player_data)[2] <- "Height"
season_data <- merge(season_data, player_data, by = c("Player"))
```

```{r}
# orignal source select columns
select_columns <- c("Player", "Tm", "Pos", "Height", "Year", "Age", "FG", "FGA", "BLK", "MP", "PTS", "PER")

# columns that don't change per year
common_columns <- c("Player", "Tm", "Pos", "Height")

# interested observations per year
yearly_columns <- c("Age", "FG", "FGA", "MP", "BLK", "PTS", "PER")
  
# interested positions
interested_positions <- c("PG", "SG")

# wide format data
#   has yearly columns suffixed as follows
#    - latest year => "_year_latest"
#    - 2nd latest year => "_year_minus_1"
#    - 3rd latest year => "_year_minus_2"
#    - Nth latest year => "_year_minus_(N-1)"
#
get_model_data_wide <- function(season_data, years, age) {
  last_n_seasons <- subset(season_data, 
                           Year %in% years & Pos %in% interested_positions, 
                           select = c(common_columns, c("Year"), yearly_columns))
  
  n_years <- length(years)
  yearly_suffix <- c(paste("_year_minus_", (n_years - 1):1, sep = ""), "_year_latest")
  
  sorted_years <- sort(years)
  starting_age <- -1
  
  suppressWarnings(rm(wide_data))
  
  if (! missing(age)) {
    starting_age <- age
  }
  
  for (year_idx in 1:n_years) {
    year <- sorted_years[year_idx]
    if (-1 == starting_age) {
      yearly_data <- subset(last_n_seasons, Year == year, select = -c(Year))
    } else {
      yearly_data <- subset(last_n_seasons, Year == year & Age == starting_age, select = -c(Year))
    }
    colnames(yearly_data) <- c(common_columns, paste(yearly_columns, yearly_suffix[year_idx], sep = ""))
    yearly_data <- yearly_data[!duplicated(yearly_data$Player),]
    
    if (exists("wide_data")) {
      wide_data <- merge(wide_data, yearly_data, by = common_columns)
    } else {
      wide_data <- yearly_data
    }

    if (-1 != starting_age) {
      starting_age <- starting_age + 1
    }    
  }
  
  wide_data$Pos <- factor(wide_data$Pos)
  wide_data$Tm <- factor(wide_data$Tm)

  return(wide_data)
}

# converts long format to wide format
#
wide_data_to_long_data <- function(wide_data, years) {

    # now have records where data exists for all years for each player
  # no unflatten it.
  n_years <- length(years)
  yearly_suffix <- c(paste("_year_minus_", (n_years - 1):1, sep = ""), "_year_latest")
  
  suppressWarnings(rm(long_data))
  sorted_years <- sort(years)
  for (year_idx in 1:n_years) {
    year <- sorted_years[year_idx]
    yearly_data <- subset(wide_data, select = c(common_columns, paste(yearly_columns, yearly_suffix[year_idx], sep = "")))
    
    colnames(yearly_data) <- c(common_columns, yearly_columns)
    yearly_data$Year = year
    
    if (exists("long_data")) {
      long_data <- rbind(long_data, yearly_data)
    } else {
      long_data <- yearly_data
    }
  }
  
  return(long_data)
}

```

```{r}
interested_years <- c(2014, 2015, 2016, 2017)

model_data <- get_model_data_wide(season_data, interested_years)
colnames(model_data)
# filter by teams
interested_teams <- c("ATL", "GSW", "MEM", "TOR", "WAS")
model_data <- subset(model_data, Tm %in% interested_teams)
model_data$Tm <- factor(model_data$Tm)

nrow(model_data)
```

```{r}
model_data_long <- wide_data_to_long_data(model_data, interested_years)
colnames(model_data_long)
nrow(model_data_long)
summary(model_data_long$Age)
```

```{r}
# plot
ggplot(data = model_data_long, aes(x=Year, y=FG)) + geom_line(aes(colour=Player))
```

```{r}
# plot
ggplot(data = model_data_long, aes(x=Year, y=PER)) + geom_line(aes(colour=Player))

```


```{r}
ggplot(model_data, aes(Height)) +
  geom_line(aes(y = FG_year_latest), colour = "red") + 
  geom_line(aes(y = FG_year_minus_1), color = "green") + 
  geom_line(aes(y = FG_year_minus_2), color = "blue")
```


```{r}
model_data$HeightScaled <- as.vector(scale(model_data$Height, scale = 2 * sd(model_data$Height)))
model1_d <- list(FG = model_data[, grep("FG_year_.+", names(model_data), value = TRUE)],
           FGA = model_data[, grep("FGA_year_.+", names(model_data), value = TRUE)],
           pos = unclass(model_data$Pos),
           htScaled = model_data$HeightScaled
           )
model1_inits <- list(
  list(betaPos=c(10, 10), betaHt = 10, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 123),
  list(betaPos=c(10, -10), betaHt = -10, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 234),
  list(betaPos=c(-10, -10), betaHt = -10, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 345),
  list(betaPos=c(-10, 10), betaHt = 10, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 456)
              )
```

In case we are only interested in Teams or Positions for which at least N records are avaialble

```{r}
nrow(model_data)
table(model_data$Tm) >= 6
model_data_1 <- subset(model_data, model_data$Tm %in% (table(model_data$Tm) >= 3))
nrow(model_data_1)
```

8 rows with one row per player

FGM_year_ : Field Goals Made for the given _year_
FGA_year : Field Goals Attempted for the given _year_
Yr_Exper_year : Years of Experience for the given _year_

```{r}
data <- read.table("data_NBAstats.csv", header=TRUE, sep = ",")
data[, c("names", "FGM_2017", "FGA_2017", "Yr_Exper_2017", "FGM_2016", "FGA_2016", "Yr_Exper_2016", "FGM_2015", "FGA_2015", "Yr_Exper_2015")]
```

## Additional fields creation

Probabilities derived from the current observation as $prob_{year} = FGM_{year}/FGA_{year}$

```{r}
data$Prob_2017 <- data$FGM_2017 / data$FGA_2017
data$Prob_2016 <- data$FGM_2016 / data$FGA_2016
data$Prob_2015 <- data$FGM_2015 / data$FGA_2015
```

# Model

JAGS model. I will use scaled-t1 on coefficients in beta. and a flat uniform distribution for sigma of player effect
```{r,eval=F}

data {
  dimY <- dim(FGM)
}
model {
  for (i in 1:dimY[1]) { ## row per player; total 8 players
    
    for (j in 1:dimY[2]) { ## column per year; total 3 years i.e. 2017, 2016, 2015
      
      FGM[i,j] ~ dbin(prob[i,j], FGA[i,j])
      
      logit(prob[i,j]) <- beta.Year[i]*Yr.Exper[i,j]+Player.Effect[i]
	  
      FGMrep[i,j] ~ dbin(prob[i,j],FGA[i,j])
    }
    

      beta.Year[i] ~ dt(0,0.16,1)
      
      Player.Effect[i] ~ dnorm(mu, 1/sigmaPE^2)
  }

  mu ~ dt(0,0.01,1)

  sigmaPE ~ dunif(0,100)

}
```


## Prepare data binding

Subset out the FGM(field goal made),FGA(field goal attempt),Yr.Exper(Years of professional experience)

```{r}
d1 <- list(FGM = data[,c("FGM_2017","FGM_2016","FGM_2015")],
           FGA = data[,c("FGA_2017","FGA_2016","FGA_2015")],
           Yr.Exper = data[,c("Yr_Exper_2017","Yr_Exper_2016","Yr_Exper_2015")])

```

## Initialization of chains

```{r}
inits1 <- list(list(beta.Year=c(-1,-1,-1,-1,-1,-1,-1,-1),mu=10, sigmaPE=0.001, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 123),
               list(beta.Year=c(-1,-1,-1,-1,-1,-1,-1,-1),mu=-10,sigmaPE=99, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 234),
               list(beta.Year=c(-1,-1,-1,-1,-1,-1,-1,-1),mu=10,sigmaPE=99, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 345),
               list(beta.Year=c(-1,-1,-1,-1,-1,-1,-1,-1),mu=-10,sigmaPE=0.01, .RNG.name = "base::Marsaglia-Multicarry", .RNG.seed = 456)
               )
```

## Build model

```{r}
m1 <- jags.model('model-logistic.bug', d1, inits = inits1, n.chains = 4, n.adapt = 1000)
```

## Burning and check convergence

```{r}
update(m1, 1024000)
```

## Posterior samples

```{r}
x1 <- coda.samples(m1,c('beta.Year','Player.Effect'), n.iter = 40000)

gelman.diag(x1, autoburnin = F)
```

## Effective samples sizes are adequate.

```{r}
effectiveSize(x1)
```



# Computation

## Retrieve replicate dataset and probabilities

```{r}
x1 <- coda.samples(m1, c('beta.Year','Player.Effect','prob','FGMrep'), n.iter = 40000)
```

## Check overdispersion, chi-square discrepancy

```{r}
df <- as.matrix(x1)
probs1 <- df[,paste('prob[',1:8, ',',1,']',sep='')] # 2017
probs2 <- df[,paste('prob[',1:8, ',',2,']',sep='')] # 2016
probs3 <- df[,paste('prob[',1:8, ',',3,']',sep='')] # 2015
probs <-  cbind(probs1,probs2,probs3)

FGMrep1 <- df[,paste('FGMrep[',1:8, ',',1,']',sep='')] # 2017
FGMrep2 <- df[,paste('FGMrep[',1:8, ',',2,']',sep='')] # 2016
FGMrep3 <- df[,paste('FGMrep[',1:8, ',',3,']',sep='')] # 2015
FGMrep <-  cbind(FGMrep1,FGMrep2,FGMrep3)

FGM.v <- unlist(d1$FGM)
FGA.v <- unlist(d1$FGA)
```


```{r}

Tchi <- matrix(NA, nrow(FGMrep), 24)
Tchirep <- matrix(NA, nrow(FGMrep), 24)

for (s in 1:nrow(FGMrep)){
        Tchi[s,] <- sum( (FGM.v - FGA.v * probs[s,])^2 / (FGA.v * probs[s,] * (1-probs[s,])) )
        Tchirep[s,] <- sum( (FGMrep[s,] - FGA.v * probs[s,])^2 / (FGA.v * probs[s,] * (1-probs[s,])) )
}
```

```{r}
mean(Tchirep>=Tchi)
```

No over dispersion problem

# Model Assessment 

```{r}
ilogit <-  function(x) 1/(1+exp(-x))

get_player_posterior_probs <- function(player_row_id) {
  beta.Year <- df[,paste('beta.Year[', player_row_id, ']', sep = '')]
  player.Effect <- df[,paste('Player.Effect[', player_row_id, ']', sep = '')]
  
  posterior_2017 <- numeric(nrow(probs1))
  posterior_2016 <- numeric(nrow(probs1))
  posterior_2015 <- numeric(nrow(probs1))
  
  for (s in 1:nrow(probs1)) {
    posterior_2017[s] <- ilogit(beta.Year[s] * data[player_row_id, "Yr_Exper_2017"] + player.Effect[s])
    posterior_2016[s] <- ilogit(beta.Year[s] * data[player_row_id, "Yr_Exper_2016"] + player.Effect[s])
    posterior_2015[s] <- ilogit(beta.Year[s] * data[player_row_id, "Yr_Exper_2015"] + player.Effect[s])
  }
  posterior <- cbind(posterior_2017,posterior_2016,posterior_2015)
  
  return(posterior)
}

get_player_posterior_vs_observed <- function(player_row_id, posterior) {
  posterior_means <- apply(posterior, 2, mean)

  df_compare <- data.frame(posterior = as.vector(posterior_means), 
                             observed = as.vector(as.matrix(data[player_row_id, c("Prob_2017", "Prob_2016", "Prob_2015")])))
  rownames(df_compare) <- c("2017", "2016", "2015")

  return (df_compare)
}
plot_player_posterior_probs <- function(player_row_id, posterior) {
  plot1 <- densityplot(posterior[,"posterior_2017"],
            panel = function(x, ...) {
             panel.densityplot(x, ...)
              panel.abline(v = mean(x), col.line = "blue")
              panel.abline(v = data[player_row_id, "Prob_2017"], col.line = "red")
            },
            xlab = "Posterior probability 2017"
            )
  plot2 <- densityplot(posterior[,"posterior_2016"],
            panel = function(x, ...) {
             panel.densityplot(x, ...)
              panel.abline(v = mean(x), col.line = "blue")
              panel.abline(v = data[player_row_id, "Prob_2016"], col.line = "red")
            },
            xlab = "Posterior probability 2016"
            )
  plot3 <- densityplot(posterior[,"posterior_2015"],
            panel = function(x, ...) {
             panel.densityplot(x, ...)
              panel.abline(v = mean(x), col.line = "blue")
              panel.abline(v = data[player_row_id, "Prob_2015"], col.line = "red")
            },
            xlab = "Posterior probability 2015"
            )
  
  grid.arrange(plot1, plot2, plot3, ncol = 3, nrow = 1)
}
```

## Check Stephen Curry successfully makes an attempted field goal for the past three years.

```{r}
player_row_id <- which(data$name == "Stephen Curry")
# posterior prob
posterior <- get_player_posterior_probs(player_row_id)
```

```{r}
df_posterior_observed <- get_player_posterior_vs_observed(player_row_id, posterior)
df_posterior_observed
```

The posterior density does not show Stephen's improvement of making a field goal, let's also check Russell Westbrook.

```{r}
plot_player_posterior_probs(player_row_id, posterior)
```

## Check James Harden successfully makes an attempted field goal for the past three years.

```{r}
player_row_id <- which(data$name == "James Harden")
# posterior prob
posterior <- get_player_posterior_probs(player_row_id)
```

```{r}
df_posterior_observed <- get_player_posterior_vs_observed(player_row_id, posterior)
df_posterior_observed
```

```{r}
plot_player_posterior_probs(player_row_id, posterior)
```

## Check Giannis Antetolounmpo successfully makes an attempted field goal for the past three years.

```{r}
player_row_id <- which(data$name == "Giannis Antetolounmpo")
# posterior prob
posterior <- get_player_posterior_probs(player_row_id)
```

```{r}
df_posterior_observed <- get_player_posterior_vs_observed(player_row_id, posterior)
df_posterior_observed
```

```{r}
plot_player_posterior_probs(player_row_id, posterior)
```

## Check Russell Westbrook successfully makes an attempted field goal for the past three years.

```{r}
player_row_id <- which(data$name == "Russell Westbrook")
# posterior prob
posterior <- get_player_posterior_probs(player_row_id)
```

```{r}
df_posterior_observed <- get_player_posterior_vs_observed(player_row_id, posterior)
df_posterior_observed
```

```{r}
plot_player_posterior_probs(player_row_id, posterior)
```

## Check Kyrie Irving successfully makes an attempted field goal for the past three years.

```{r}
player_row_id <- which(data$name == "Kyrie Irving")
# posterior prob
posterior <- get_player_posterior_probs(player_row_id)
```

```{r}
df_posterior_observed <- get_player_posterior_vs_observed(player_row_id, posterior)
df_posterior_observed
```

```{r}
plot_player_posterior_probs(player_row_id, posterior)
```

# Results
# Contributions
# References
# Appendix

* [NBA Dataset](https://www.kaggle.com/drgilermo/nba-players-stats/downloads/nba-players-stats-since-1950.zip)

* [Basketball reference glossary](https://www.basketball-reference.com/about/glossary.html)


